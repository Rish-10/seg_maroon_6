<div class="row g-4">
  {% for recipe in recipes %}
    <div class="col-12 col-md-6 col-lg-4">
      <div class="recipe-card d-flex flex-column">
        <!-- Top: Title and Description -->
        <div class="recipe-card-header p-3">
          <h5 class="mb-1">
            <a class="text-decoration-none" href="{% url 'recipe_detail' recipe.pk %}">
              {{ recipe.title }}
            </a>
          </h5>
          <p class="mb-1 text-truncate-2">{{ recipe.description|default:"No description yet." }}</p>
          {% if show_author != False %}
            <small class="text-muted">by <a href="{% url 'profile_page' recipe.author.username %}">{{ recipe.author.username }}</a></small>
          {% endif %}
        </div>

        <!-- Middle: Image -->
        {% with preview=recipe.images.first %}
          {% if preview and preview.image and preview.image.name %}
            <div class="recipe-card-image" style="aspect-ratio: 1 / 1; overflow: hidden; background: #f8f8f8; display: flex; align-items: center; justify-content: center;">
              <img src="{{ preview.image.url }}" class="w-100 h-100" alt="{{ preview.caption|default:'Recipe image' }}" style="object-fit: contain;">
            </div>
          {% else %}
            <div class="recipe-card-image" style="aspect-ratio: 1 / 1; display: flex; align-items: center; justify-content: center; background: #E8E5DF;">
              <i class="bi bi-egg-fried" style="font-size: 4rem; color: #800020;"></i>
            </div>
          {% endif %}
        {% endwith %}

        <!-- Bottom: Ratings, Categories, and Buttons -->
        <div class="recipe-card-footer p-3 mt-auto">
          <!-- Categories -->
          {% if recipe.categories.exists %}
            <div class="mb-2">
              {% for category in recipe.categories.all|slice:":2" %}
                <span class="badge bg-secondary me-1 mb-1">{{ category.label }}</span>
              {% endfor %}
            </div>
          {% endif %}

          <!-- Rating Display -->
          <div class="mb-2 d-flex justify-content-between align-items-center">
            <div>
              {% for star in star_range %}
                {% if recipe.rating_avg|default:0 >= star %}
                  <i class="bi bi-star-fill text-warning"></i>
                {% else %}
                  <i class="bi bi-star text-warning"></i>
                {% endif %}
              {% endfor %}
              <small class="ms-1 text-muted">{{ recipe.rating_avg|default:0|floatformat:1 }}</small>
            </div>
            <small class="text-muted">{{ recipe.created_at|date:"d M Y" }}</small>
          </div>

          <!-- Action Buttons -->
          <!-- <div class="d-flex justify-content-between align-items-center mb-2">
            <div>
              {% for star in star_range %}
                ...
              {% endfor %}
              <small class="ms-1 text-muted">{{ recipe.rating_avg|default:0|floatformat:1 }}</small>
            </div>
            <small class="text-muted">{{ recipe.created_at|date:"d M Y" }}</small>
          </div> -->

          <small class="text-muted d-block mb-2">{{ recipe.favourites_count }} favourites</small>

          <div class="d-flex gap-2">
            <form method="post" action="{% url 'recipe_favourite_toggle' recipe.pk %}" class="flex-fill .fav-btn">
              {% csrf_token %}
              <input type="hidden" name="next" value="{{ request.path }}">
              {% if user.is_authenticated and recipe in user.favourites.all %}
                <button class="btn btn-sm btn-outline-danger w-100" type="submit">
                  <i class="bi bi-heart-fill"></i> Favourited
                </button>
              {% else %}
                <button class="btn btn-sm btn-outline-primary w-100" type="submit">
                  <i class="bi bi-heart"></i> Favourite
                </button>
              {% endif %}
            </form>

            <a href="{% url 'recipe_detail' recipe.pk %}" class="btn btn-sm btn-dark flex-fill">View Recipe</a>
          </div>
        </div>
      </div>
    </div>
  {% endfor %}
</div>
