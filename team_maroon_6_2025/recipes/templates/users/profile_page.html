{% extends 'base_content.html' %}
{% block content %}
<div class="container">
    <div class="profile-header">
        <div class="profile-info">
            <img src="{{ profile_user.gravatar }}" alt="Avatar" class="avatar">
            <h1>{{ profile_user.full_name }}</h1>
            <p class="handle">{{ profile_user.username }}</p>

            <p class="bio">{{ profile_user.bio }}</p>

            <div class="stats">
                <span><strong>{{ profile_user.recipes.count }}</strong> Recipes</span>
                <span><strong>{{ profile_user.follower_count }}</strong> Followers</span>
                <span><strong>{{ profile_user.following_count }}</strong> Following</span>
            </div>

            {% if request.user.is_authenticated and request.user != profile_user %}
                <form action="{% url 'follow_toggle' profile_user.username %}" method="POST">
                    {% csrf_token %}
                    {% if is_following %}
                        <button type="submit" class="btn btn-secondary">Unfollow</button>
                    {% else %}
                        <button type="submit" class="btn btn-primary">Follow</button>
                    {% endif %}
                </form>
            {% endif %}
        </div>
    </div>

    <hr>

    <div class="row mt-4">
        <div class="col-12 mt-3">
          <h3>Recipes</h3> {% if user_recipes %}
            <div class="list-group">
              {% for recipe in user_recipes %}
                <div class="list-group-item">
                  <div class="d-flex">

                    {% with preview=recipe.images.first %}
                      {% if preview %}
                        <div class="me-3" style="width: 150px; height: 150px; overflow: hidden;">
                          <img src="{{ preview.image.url }}" class="img-thumbnail" alt="{{ preview.caption|default:'Recipe image' }}">
                        </div>
                      {% endif %}
                    {% endwith %}

                    <div class="flex-grow-1 d-flex justify-content-between align-items-start">
                      <div>
                        <h5 class="mb-1">
                          <a class="text-decoration-none" href="{% url 'recipe_detail' recipe.pk %}">
                            {{ recipe.title }}
                          </a>
                        </h5>
                        <p class="mb-1">{{ recipe.description|default:"No description yet." }}</p>

                        </div>

                      <div class="text-end">
                        <small class="d-block">{{ recipe.created_at|date:"d M Y H:i" }}</small>

                        <form method="post" action="{% url 'recipe_favourite_toggle' recipe.pk %}" class="mt-2">
                          {% csrf_token %}
                          <input type="hidden" name="next" value="{{ request.path }}">
                          {% if user.is_authenticated and recipe in user.favourites.all %}
                            <button class="btn btn-sm btn-outline-danger" type="submit">Unfavourite</button>
                          {% else %}
                            <button class="btn btn-sm btn-outline-primary" type="submit">Favourite</button>
                          {% endif %}
                        </form>

                        <form method="post" action="{% url 'recipe_like_toggle' recipe.pk %}" class="mt-2">
                          {% csrf_token %}
                          <input type="hidden" name="next" value="{{ request.path }}">
                          {% if user.is_authenticated and user in recipe.likes.all %}
                            <button class="btn btn-sm btn-outline-success" type="submit">Unlike</button>
                          {% else %}
                            <button class="btn btn-sm btn-success" type="submit">Like</button>
                          {% endif %}
                        </form>

                        <span class="badge bg-light text-dark mt-2 d-inline-block">Likes: {{ recipe.likes_count }}</span>

                        <div class="mt-3">
                          {% for comment in recipe.comments.all|slice:":3" %}
                            <div class="border bg-light p-2 mb-2">
                              <small><strong>{{ comment.author.username }}</strong> â€¢ {{ comment.created_at|date:"d M Y H:i" }}</small>
                              <p class="mb-0">{{ comment.body }}</p>
                            </div>
                          {% empty %}
                            <p class="text-muted mb-0">No comments yet.</p>
                          {% endfor %}
                          {% if recipe.comments.count > 3 %}
                            <a href="{% url 'recipe_detail' recipe.pk %}">View all comments</a>
                          {% endif %}
                        </div>

                      </div>
                    </div>
                  </div>
                </div>
              {% endfor %}

            </div>
          {% else %}
            <p class="text-muted">This user hasn't posted any recipes yet.</p>
          {% endif %}
        </div>
    </div>
</div>
{% endblock %}